
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Função para verificar se o usuário é um profissional
    function isProfessional() {
      return get(/databases/$(database)/documents/tutors/$(request.auth.uid)).data.role == 'professional';
    }

    // Regras para a coleção 'tutors' (perfis de usuários)
    match /tutors/{userId} {
      // Um usuário pode ler e escrever (criar, atualizar) apenas no seu próprio documento.
      allow read, write: if request.auth.uid == userId;
      // Profissionais podem ler os dados de qualquer tutor.
      allow get: if isProfessional();
    }

    // Regras para a coleção 'pets'
    match /pets/{petId} {
      // O dono do pet pode fazer tudo. O ID do tutor está armazenado no documento do pet.
      allow read, update, delete: if request.auth.uid == resource.data.tutorId;
      // Qualquer usuário autenticado pode criar um novo pet (o tutorId será validado na criação).
      allow create: if request.auth != null;
      // Profissionais podem ler os dados de qualquer pet.
      allow get, list: if isProfessional();
    }

    // Regras para a coleção 'appointments' (agendamentos)
    match /appointments/{appointmentId} {
       // O dono do pet pode ler o agendamento.
      allow get, list: if request.auth.uid == resource.data.tutorId;
      // Qualquer usuário autenticado pode criar um agendamento.
      allow create: if request.auth != null;
      // Profissionais podem ler e atualizar (ex: mudar status) qualquer agendamento.
      allow read, update: if isProfessional();
    }
    
    // Regras para a coleção 'invoices' (faturas)
    match /invoices/{invoiceId} {
      // O cliente pode ler suas próprias faturas.
      allow read: if request.auth.uid == resource.data.clientId;
      // Profissionais podem ler e atualizar qualquer fatura.
      allow read, update, create: if isProfessional();
    }

    // Regras para o inventário
    match /inventory/{itemId} {
      // Apenas profissionais podem ler e escrever no estoque.
      allow read, write: if isProfessional();
    }

    // Regras para a equipe
    match /staff/{staffId} {
       // Apenas profissionais podem ler e escrever na lista de equipe.
      allow read, write: if isProfessional();
    }
  }
}
